"use strict";(self.webpackChunkqtrobot_documentation=self.webpackChunkqtrobot_documentation||[]).push([[4633],{34659:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return l},contentTitle:function(){return c},metadata:function(){return d},assets:function(){return u},toc:function(){return m},default:function(){return k}});var n=a(87462),o=a(63366),i=(a(67294),a(3905)),r=a(55381),s=a(14702),p=["components"],l={id:"microphone",title:"QTrobot Audio processing and Microphone",hide_table_of_contents:!1},c=void 0,d={unversionedId:"modules/microphone",id:"modules/microphone",title:"QTrobot Audio processing and Microphone",description:"QTrobot has an integrated High-performance digital microphones array in the head. It is a ReSpeaker Mic Array v2.0 board from SeedStudio with plenty of features such as voice activity detection, direction of arrival, beamforming and noise Suppression. This powerful microphone can be used in variety of scenarios such as voice interaction, interactive vision-voice applications, multichannel raw audio recording and processing and etc. It is connected to Raspberry Pi (QTRP) via USB port and it is open for developers to freely tune, configure and use it in standard ways.",source:"@site/docs/modules/microphone.md",sourceDirName:"modules",slug:"/modules/microphone",permalink:"/docs/modules/microphone",tags:[],version:"current",frontMatter:{id:"microphone",title:"QTrobot Audio processing and Microphone",hide_table_of_contents:!1},sidebar:"modules",previous:{title:"QTrobot Sound and Speech",permalink:"/docs/modules/speakers"},next:{title:"QTrobot Vision and 3D Camera",permalink:"/docs/modules/camera"}},u={},m=[{value:"Software interfaces",id:"software-interfaces",level:2},{value:"Offline speech recognition",id:"offline-speech-recognition",level:2},{value:"Accessing voice recognition from terminal",id:"accessing-voice-recognition-from-terminal",level:3},{value:"Accessing voice recognition from code",id:"accessing-voice-recognition-from-code",level:3},{value:"Accessing voice recognition using QTrobot visual studio blocks",id:"accessing-voice-recognition-using-qtrobot-visual-studio-blocks",level:3},{value:"Installing more languages",id:"installing-more-languages",level:3},{value:"Online speech recognition",id:"online-speech-recognition",level:2},{value:"Setup instructions",id:"setup-instructions",level:3},{value:"Google account and API credentials",id:"google-account-and-api-credentials",level:4},{value:"Python virtualenvironment",id:"python-virtualenvironment",level:4},{value:"Link to catkin workspace and build",id:"link-to-catkin-workspace-and-build",level:4},{value:"Autostart",id:"autostart",level:4},{value:"Accessing voice recognition from terminal",id:"accessing-voice-recognition-from-terminal-1",level:3},{value:"<strong>Tips</strong> for better speech recognition",id:"tips-for-better-speech-recognition",level:2},{value:"Accessing audio, voice direction and other data",id:"accessing-audio-voice-direction-and-other-data",level:2},{value:"Configuring qt_respeaker_app",id:"configuring-qt_respeaker_app",level:3},{value:"Recording raw audio data",id:"recording-raw-audio-data",level:3},{value:"Microphone tuning tool",id:"microphone-tuning-tool",level:2},{value:"What can I tune?",id:"what-can-i-tune",level:3},{value:"What can I do with the tunned values?",id:"what-can-i-do-with-the-tunned-values",level:3}],h={toc:m};function k(e){var t=e.components,a=(0,o.Z)(e,p);return(0,i.kt)("wrapper",(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"QTrobot has an integrated High-performance digital microphones array in the head. It is a ",(0,i.kt)("a",{parentName:"p",href:"https://wiki.seeedstudio.com/ReSpeaker_Mic_Array_v2.0/"},(0,i.kt)("strong",{parentName:"a"},"ReSpeaker Mic Array v2.0"))," board from SeedStudio with plenty of features such as voice activity detection, direction of arrival, beamforming and noise Suppression. This powerful microphone can be used in variety of scenarios such as voice interaction, interactive vision-voice applications, multichannel raw audio recording and processing and etc. It is connected to Raspberry Pi (QTRP) via USB port and it is open for developers to freely tune, configure and use it in standard ways. "),(0,i.kt)("center",null,(0,i.kt)("img",{src:"/img/microphone.png",alt:"microphone"})),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Specification:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"4 High-performance digital microphones"),(0,i.kt)("li",{parentName:"ul"},"supports far-field voice capture"),(0,i.kt)("li",{parentName:"ul"},"Speech algorithm on-chip"),(0,i.kt)("li",{parentName:"ul"},"12 programmable RGB LED indicators"),(0,i.kt)("li",{parentName:"ul"},"Microphones: ST MP34DT01TR-M"),(0,i.kt)("li",{parentName:"ul"},"Sensitivity: -26 dBFS (omnidirectional)"),(0,i.kt)("li",{parentName:"ul"},"Acoustic overload point: 120 dB SPL"),(0,i.kt)("li",{parentName:"ul"},"SNR: 61 dB"),(0,i.kt)("li",{parentName:"ul"},"Max Sample Rate:16Khz")),(0,i.kt)("hr",null),(0,i.kt)("h2",{id:"software-interfaces"},"Software interfaces"),(0,i.kt)("p",null,"Like any other standard microphones, the QTrobot Respeaker microphone is an standard Linux capture device which is managed by ALSA driver. Bellow you can see the output of ",(0,i.kt)("inlineCode",{parentName:"p"},"arecord -l")," command which lists all capture devices in QTRP: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"**** List of CAPTURE Hardware Devices ****\ncard 2: ArrayUAC10 [ReSpeaker 4 Mic Array (UAC1.0)], device 0: USB Audio [USB Audio]\n  Subdevices: 0/1\n  Subdevice #0: subdevice #0\n")),(0,i.kt)("p",null,"QTrobot comes with following pre-installed software for speech recognition, accessing raw raw microphone data and tuning tool. These software interfaces are installed on QTRP because direct access to the microphone device is required. "),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/luxai-qtrobot/software/tree/master/apps/qt_respeaker_app"},(0,i.kt)("strong",{parentName:"a"},"qt_respeaker_app")),": ROS services for streaming multichannel microphone audio data, voice activity, voice direction and etc. (",(0,i.kt)("strong",{parentName:"li"},"running by default"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/luxai-qtrobot/software/tree/master/tools/respeaker_mic_tunning"},(0,i.kt)("strong",{parentName:"a"},"respeaker_mic_tuning")),": A graphical tools for detailed tuning of Respeaker microphone")),(0,i.kt)("p",null,"Installed on QTPC: "),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/luxai-qtrobot/software/tree/master/apps/qt_vosk_app"},(0,i.kt)("strong",{parentName:"a"},"qt_vosk_app")),": an ",(0,i.kt)("em",{parentName:"li"},"offline")," and multilingual speech recognition ROS service based on VOSK library. (",(0,i.kt)("strong",{parentName:"li"},"running by default"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/luxai-qtrobot/software/tree/master/apps/qt_gspeech_app"},(0,i.kt)("strong",{parentName:"a"},"qt_gspeech_app")),": an ",(0,i.kt)("em",{parentName:"li"},"online")," and multilingual speech recognition ROS service based on Google Speech-To-Text API")),(0,i.kt)("h2",{id:"offline-speech-recognition"},"Offline speech recognition"),(0,i.kt)("p",null,"QTrobot uses ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_vosk_app")," for offline speech recognition. The ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_vosk_app")," is installed in QTPC ",(0,i.kt)("inlineCode",{parentName:"p"},"~/catkin_ws")," and it is running by default. Some of the required language models for speech recognitions are installed in ",(0,i.kt)("inlineCode",{parentName:"p"},"~/robot/vosk/models")," in QTPC such as ",(0,i.kt)("inlineCode",{parentName:"p"},"en_US")," for English, ",(0,i.kt)("inlineCode",{parentName:"p"},"de_DE")," for German, ",(0,i.kt)("inlineCode",{parentName:"p"},"fr_FR")," for French languages.\nYou can try and use the speech recognitions in different ways. "),(0,i.kt)("h3",{id:"accessing-voice-recognition-from-terminal"},"Accessing voice recognition from terminal"),(0,i.kt)("p",null,"Like many other ROS services, you can call ",(0,i.kt)("inlineCode",{parentName:"p"},"/qt_robot/speech/recognize")," with the desired language and options. The options can be used to tell the service to stop and return the recognized words as soon one of the given options is detected. "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ rosservice call /qt_robot/speech/recognize \"language: 'en_US'\noptions:[]\ntimeout: 0\"\n")),(0,i.kt)("h3",{id:"accessing-voice-recognition-from-code"},"Accessing voice recognition from code"),(0,i.kt)("p",null,"Take a look at our ",(0,i.kt)("a",{parentName:"p",href:"/docs/tutorials/python/python_ros_vosk"},(0,i.kt)("strong",{parentName:"a"},"Python offline speech recognition"))," tutorial to learn how to call ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_vosk_app")," services from a Python code. Here is also a Python code snippet: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"from qt_vosk_app.srv import *\nrecognize = rospy.ServiceProxy('/qt_robot/speech/recognize', speech_recognize)\nresp = recognize(\"en_US\", ['blue', 'green', 'red'], 10)\nprint(\"I got: %s\", resp.transcript)\n")),(0,i.kt)("h3",{id:"accessing-voice-recognition-using-qtrobot-visual-studio-blocks"},"Accessing voice recognition using QTrobot visual studio blocks"),(0,i.kt)("p",null,"QTrobot studio offers very flexible and powerful blocks to handle complex ROS messages and interact with other publishers, subscribers and services. You can follow ",(0,i.kt)("a",{parentName:"p",href:"/docs/tutorials/graphical/studio_ros"},(0,i.kt)("strong",{parentName:"a"},"Using ROS blocks"))," tutorial to learn how to call ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_vosk_app")," using QTrobot visual studio blocks."),(0,i.kt)("h3",{id:"installing-more-languages"},"Installing more languages"),(0,i.kt)("p",null,"If your required language is not already installed on the robot, you can go through the following steps to add it to the ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_vosk_app"),":"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"find the proper model of your desired language from ",(0,i.kt)("a",{parentName:"li",href:"https://alphacephei.com/vosk/models"},"https://alphacephei.com/vosk/models")," list. "),(0,i.kt)("li",{parentName:"ol"},"Download and unzip the model into ",(0,i.kt)("inlineCode",{parentName:"li"},"~/robot/vosk/models")," QTPC  folder. "),(0,i.kt)("li",{parentName:"ol"},"Rename the model folder to the short language code (ISO) such as ",(0,i.kt)("inlineCode",{parentName:"li"},"it_IT")," for Italian. "),(0,i.kt)("li",{parentName:"ol"},"relaunch ",(0,i.kt)("inlineCode",{parentName:"li"},"qt_vosk_app")," or simply reboot the QTrobot.")),(0,i.kt)("h2",{id:"online-speech-recognition"},"Online speech recognition"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Always check if you have the latest code of the 'qt_gspeech_app' on your QTPC. You can check with 'git status' command in the '~/robot/code/software' folder."),(0,i.kt)("p",{parentName:"div"},"Latest update (10. May 2023):"),(0,i.kt)("ol",{parentName:"div"},(0,i.kt)("li",{parentName:"ol"},"Enabled Automatic punctuation"),(0,i.kt)("li",{parentName:"ol"},"Default Timeout of 5 min: call the service with timeout=0 to enable it"),(0,i.kt)("li",{parentName:"ol"},"BUG FIX: Sometimes Google speech recognition would return empty response when providing timeout in rosservice call, use default timeout instead ")))),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/luxai-qtrobot/software/tree/master/apps/qt_gspeech_app"},(0,i.kt)("strong",{parentName:"a"},"qt_gspeech_app")),"\nprovides an ",(0,i.kt)("strong",{parentName:"p"},"online")," (required INTERNET connection) multilingual speech recognition ROS service based on Google Speech-To-Text API. The ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_gspeech_app")," is not running by default and it ",(0,i.kt)("strong",{parentName:"p"},"cannot")," be run simultaneously with other voice apps such as ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_vosk_app"),". To disable the ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_vosk_app"),", you can simply comment the corresponding line in ",(0,i.kt)("inlineCode",{parentName:"p"},"~/robot/autostart/autostart_screens.sh")," on QTPC and reboot the robot. "),(0,i.kt)("h3",{id:"setup-instructions"},"Setup instructions"),(0,i.kt)("h4",{id:"google-account-and-api-credentials"},"Google account and API credentials"),(0,i.kt)("p",null,"Please follow the setup instructions to ",(0,i.kt)("a",{parentName:"p",href:"https://cloud.google.com/speech-to-text/docs/quickstart-client-libraries#before-you-begin"},(0,i.kt)("strong",{parentName:"a"},"setup your google account"))," before enabling the ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_gspeech_app"),"."),(0,i.kt)("p",null,"Export your google api credentials in .json file and save it on the QTPC."),(0,i.kt)("p",null,"Edit and add to the last line in ",(0,i.kt)("inlineCode",{parentName:"p"},"~/.bash_aliases")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'export GOOGLE_APPLICATION_CREDENTIALS=`<path-to-your-file>`\n*example*:"/home/qtrobot/credentials.json"\n')),(0,i.kt)("h4",{id:"python-virtualenvironment"},"Python virtualenvironment"),(0,i.kt)("p",null,"We recommend you use ",(0,i.kt)("a",{parentName:"p",href:"https://docs.python.org/3/library/venv.html"},"python virtual environments")," to install all python modules and setup the google speech recognition."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Install python virtual environment:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt install python3.8-venv\n"))),(0,i.kt)("li",{parentName:"ol"},"Navigate to 'qt_gspeech_app' folder:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cd ~/robot/code/software/apps/qt_gspeech_app\n"))),(0,i.kt)("li",{parentName:"ol"},"Setup virtual environment:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"python3 -m venv .venv\n"))),(0,i.kt)("li",{parentName:"ol"},"To use is you just need to activate it:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"source .venv/bin/activate\n"))),(0,i.kt)("li",{parentName:"ol"},"install all python modules and plugins inside this virtual environment.")),(0,i.kt)("h4",{id:"link-to-catkin-workspace-and-build"},"Link to catkin workspace and build"),(0,i.kt)("p",null,"To be able to use rosservice you need to link the code to the catkin workspace and build it:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"navigate to catkin workspace:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cd ~/catkin_ws/src\n"))),(0,i.kt)("li",{parentName:"ol"},"link the qt_gspeech_app:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ln -s /home/qtrobot/robot/code/software/apps/qt_gspeech_app .\n"))),(0,i.kt)("li",{parentName:"ol"},"rebuild catkin workspace:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cd ~/catkin_ws && caktin_make -j4\n")))),(0,i.kt)("h4",{id:"autostart"},"Autostart"),(0,i.kt)("p",null,"To enable it in autostart script (",(0,i.kt)("inlineCode",{parentName:"p"},"~/robot/autostart/autostart_screens.sh"),") on QTPC follow next steps: "),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"edit autostart_screen.sh"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"nano ~/robot/autostart/autostart_screens.sh\n")),(0,i.kt)("p",{parentName:"li"},"and add this line below other scripts:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'run_script "start_qt_gspeech_app.sh"\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'create "start_qt_gspeech_app.sh"'),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"nano ~/robot/autostart/start_qt_gspeech_app.sh\n")),(0,i.kt)("p",{parentName:"li"},"add and edit the following content:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'# !/bin/bash\n\n source /home/qtrobot/robot/autostart/qt_robot.inc\n SCRIPT_NAME="start_qt_gspeech_app"\n LOG_FILE=$(prepare_logfile "$SCRIPT_NAME")\n\n {\n prepare_ros_environment\n wait_for_ros_node "/rosout" 60\n\n source /home/qtrobot/catkin_ws/src/qt_gspeech_app/.venv/bin/activate;\n python /home/qtrobot/catkin_ws/src/qt_gspeech_app/src/qt_gspeech_app_node.py;\n\n } &>> ${LOG_FILE}\n'))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"save the file and reboot the QTrobot"))),(0,i.kt)("h3",{id:"accessing-voice-recognition-from-terminal-1"},"Accessing voice recognition from terminal"),(0,i.kt)("p",null,"Similar to the offline version of speech recognition, the interface can be accessed using ROS Service ",(0,i.kt)("inlineCode",{parentName:"p"},"/qt_robot/speech/recognize")," command line tools as shown bellow: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"rosservice call /qt_robot/speech/recognize \"language: 'en_US'\noptions:\n- ''\ntimeout: 10\"\n")),(0,i.kt)("p",null,"You can refer to the instruction given above for the offline version of the voice recognition to use the ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_gspeech_app")," service in a Python code or using QTrobot visual studio blocks."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"If you would like to use ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_vosk_app")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_gspeech_app"),' at the same time, then you will need to change rosservice that they are providing. By default both of them are using "qt_robot/speech/recognize".'),(0,i.kt)("p",{parentName:"div"},"To change the rosservice for qt_gspeech_app follow the next steps on QTPC:"),(0,i.kt)("ol",{parentName:"div"},(0,i.kt)("li",{parentName:"ol"},"cd ~/robot/code/software/apps/qt_gspeech_app/src"),(0,i.kt)("li",{parentName:"ol"},"edit qt_gspeech_app_node.py line 67: ",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"self.speech_recognize = rospy.Service('/qt_robot/speech/recognize', speech_recognize, self.callback_recognize)  \n")),"Change 'qt_robot/speech/recognize' to 'qt_robot/gspeech/recognize' "),(0,i.kt)("li",{parentName:"ol"},"save the file"),(0,i.kt)("li",{parentName:"ol"},"next time you run 'qt_gspeech_app' it will be available on 'qt_robot/gspeech/recognize' rosservice")))),(0,i.kt)("h2",{id:"tips-for-better-speech-recognition"},(0,i.kt)("strong",{parentName:"h2"},"Tips")," for better speech recognition"),(0,i.kt)(r.Z,{mdxType:"Icon"}," lightbulb ")," ",(0,i.kt)(s.Z,{mdxType:"Markdown"}," The microphone is installed on top of the QTrobot's head. Therefore, it is always better to talk to QTrobot from above (higher than robot) the robot so that your voice can clearly reaches the microphone. "),(0,i.kt)("br",null),(0,i.kt)("br",null)," ",(0,i.kt)(r.Z,{mdxType:"Icon"}," lightbulb ")," ",(0,i.kt)(s.Z,{mdxType:"Markdown"}," For faster and more reactive speech recognition, provide proper options (if applicable) to the service call. For example, if you only need to recognize `yes` or `no` in a sentence, give these values as options so that the service immediately return one of these two values as soon being detected by engine. "),(0,i.kt)("br",null),(0,i.kt)("br",null)," ",(0,i.kt)(r.Z,{mdxType:"Icon"}," lightbulb ")," ",(0,i.kt)(s.Z,{mdxType:"Markdown"}," In case of `qt_vosk_app`, there might be delay from the moment you switch the language at run-time until the engine loads the model and start analyzing the voice. This is related ONLY to the first call for switching the language. "),(0,i.kt)("h2",{id:"accessing-audio-voice-direction-and-other-data"},"Accessing audio, voice direction and other data"),(0,i.kt)("p",null," The ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/luxai-qtrobot/software/tree/master/apps/qt_respeaker_app"},(0,i.kt)("strong",{parentName:"a"},"qt_respeaker_app"))," provide ROS services for streaming multichannel microphone audio data, voice activity, voice direction and etc. Here is a list of the topics which are published by ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_respeaker_app"),": "),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/channel0"),": processed audio for ASR (mix of 4 microphones data)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/channel1")," : mic1 raw data")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/channel2")," : mic2 raw data")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/channel3")," : mic3 raw data")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/channel4")," : mic4 raw data")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/channel5")," : merged playback")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/is_speaking"),": VAD (Voice Activity Detection)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/sound_direction"),": DOA (Direction of Arrival)"))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"When using VOD values, please not that ",(0,i.kt)("inlineCode",{parentName:"p"},"270")," indicates to the front of QTrobot due to the microphone orientation in the robot's head. "))),(0,i.kt)("h3",{id:"configuring-qt_respeaker_app"},"Configuring qt_respeaker_app"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_respeaker_app")," is already installed in the ",(0,i.kt)("inlineCode",{parentName:"p"},"~/catkin_ws")," folder on QTRP. There is a config file ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_respeaker_app.yaml")," in the app folder which can be used to configure the Respeaker microphone especially with tuning parameters. Here are  some of the default tuning parameters: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"qt_respeaker_app: \n  suppress_pyaudio_error: true\n  update_rate: 10.0\n  tuning: \n    AGCGAIN: 50.0\n    AGCONOFF: 0\n    CNIONOFF: 0\n    GAMMA_NS_SR: 1.8\n    MIN_NS_SR: 0.01\n    STATNOISEONOFF_SR: 1  \n")),(0,i.kt)("p",null,"For most of the cases the default parameters should just work fine for you. However, you may need to adjust some of these values such as ",(0,i.kt)("inlineCode",{parentName:"p"},"AGCGAIN")," to have loader (more gain) in streamed audio or ",(0,i.kt)("inlineCode",{parentName:"p"},"MIN_NS_SR")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"GAMMA_NS_SR")," to better eliminate background noises such as QTrobot internal fan's noise. "),(0,i.kt)("h3",{id:"recording-raw-audio-data"},"Recording raw audio data"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_respeaker_app")," streams each microphone channel's data in seperate topics: ",(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/channel0 - 5"),". To record any or multiple of these channels, you can simply subscribes to the correspondig channels from QTPC (or any other computer in ROS network) and store the audio data in a WAV file or other audio formats. You can take a looke at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/luxai-qtrobot/software/blob/master/apps/qt_respeaker_app/examples/audio_record.py"},"audio_record.py")," examples to see how to record ",(0,i.kt)("inlineCode",{parentName:"p"},"/qt_respeaker_app/channel0")," in a ",(0,i.kt)("inlineCode",{parentName:"p"},".wav")," file. Here is also a simple code snippet: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"import wave\nfrom audio_common_msgs.msg import AudioData\n\ndef channel_callback(msg, wf):\n    wf.writeframes(msg.data)\n\nwf = wave.open(\"audio.wav\", 'wb')\nwf.setnchannels(1)\nwf.setsampwidth(2)\nwf.setframerate(16000)    \nrospy.Subscriber('/qt_respeaker_app/channel0', AudioData, channel_callback, wf)\n...\nwf.close()\n")),(0,i.kt)("p",null,"The above code snippet records processed audio for ASR from channel 0 and save it in ",(0,i.kt)("inlineCode",{parentName:"p"},"audio.wav")," file.  You can later process or listen to it.\nBy default some tuning parameters for noise reduction and automatic gain level are set in ",(0,i.kt)("inlineCode",{parentName:"p"},"config/qt_respeaker_app.yaml"),". If, for example, you need to record audio with different gain level, you can simply change the ",(0,i.kt)("inlineCode",{parentName:"p"},"AGCGAIN: 100.0")," and reluach the ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_respeaker_app"),"."),(0,i.kt)("h2",{id:"microphone-tuning-tool"},"Microphone tuning tool"),(0,i.kt)("p",null,"We have developed ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/luxai-qtrobot/software/tree/master/tools/respeaker_mic_tunning"},(0,i.kt)("strong",{parentName:"a"},"respeaker_mic_tuning"))," graphical tools based on ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/respeaker/usb_4_mic_array"},"ReSpeaker USB 4 Mic Array tuning software")," to easier find and tune the Respeaker microphone  parameters. Using the gui, you can tune the parameters at runtime and find the one that value which best fits your scenario such as different audio gain level or different background noise elimination. "),(0,i.kt)("center",null,(0,i.kt)("img",{src:"/img/tunning_gui.png",alt:"tunning_gui"})),(0,i.kt)("p",null,"The tool is available in QTRP under ",(0,i.kt)("inlineCode",{parentName:"p"},"~/robot/code/software/tools/")," folder. To run it:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Open a terminal on QTPC (with display attached to the robot)"),(0,i.kt)("li",{parentName:"ul"},"SSH to QTRP using ",(0,i.kt)("inlineCode",{parentName:"li"},"-X")," paramter: ",(0,i.kt)("inlineCode",{parentName:"li"},"ssh -X qtrp")),(0,i.kt)("li",{parentName:"ul"},"switch to the ",(0,i.kt)("inlineCode",{parentName:"li"},"~/robot/code/software/tools/respeaker_mic_tunning")," folder "),(0,i.kt)("li",{parentName:"ul"},"run the tuning tool: ",(0,i.kt)("inlineCode",{parentName:"li"},"python3 ./tunning_gui.py"))),(0,i.kt)("h3",{id:"what-can-i-tune"},"What can I tune?"),(0,i.kt)("p",null,"You can find the best value and tune each Respeaker parameter depending on your need. You may need to learn and got some knowledge of audio signal processing to understand all these parameters. However, in most cases you simply need to adjust the following paramters of the Respeaker microphone:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"AGCONOFF"),": to turn of or on automatic gain control. When it is 'OFF', the audio will be captured with a constant gain set by ",(0,i.kt)("inlineCode",{parentName:"li"},"AGCGAIN"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"AGCGAIN"),": the sudio signal gain value. Higher value will results loader (higher volume) audio streamed signal."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"GAMMA_NS_SR")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"MIN_NS_SR"),": these two values together specify how much background noise should be eleminated. these values already set up in QTrobot to supress and eliminate the background noise from internal fan. You can adjust these values to have more clear audio signal.")),(0,i.kt)("h3",{id:"what-can-i-do-with-the-tunned-values"},"What can I do with the tunned values?"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"respeaker_mic_tuning")," temporary adjusts the paramters of Respeaker microphone. However, values of these paramters will be reseted after rebooting the robot.\ntherefore, when you find the currect values which fits your application scenario, you can use those values to confgiure the corresponding QTrobot interfaces.\nFor example, by setting them in ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_respeaker_app.yaml")," for ",(0,i.kt)("inlineCode",{parentName:"p"},"qt_respeaker_app")," or use them to configure within your own code. here is simple code snippet to set Respeaker's paramters via a Python code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'import usb.core\nfrom tuning import Tuning\n\nmic = usb.core.find(idVendor=0x2886, idProduct=0x0018)\ndev = Tuning(mic)\n    \ndev.write("AGCONOFF", 0)\ndev.write("AGCGAIN", 100.0)\n...\n')),(0,i.kt)("p",null,"You can take a look at our ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/luxai-qtrobot/software/blob/master/apps/qt_vosk_app/src/qt_vosk_app_node.py"},"qt_vosk_app_node.py")," as a reference code."))}k.isMDXComponent=!0}}]);